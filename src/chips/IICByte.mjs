import { ChipDef } from '../components/ChipDef.mjs';

export const IICByte = new ChipDef(`
CHIP IICByte {
  IN clock0, in[8], reset;
  OUT sda, scl, done;

  PARTS:
  SixteenthClock(
    clockIn=clock0,
    reset=reset,
    half=clock1,
    quarter=clock2,
    eigth=clock3,
    sixteenth=clock4
  );
  
  // |           | clock0 | clock1 | scl | sda |
  // | substate0 |    0   |    0   |  0  |  b  |
  // | substate1 |    1   |    0   |  1  |  b  |
  // | substate2 |    0   |    1   |  1  |  b  |
  // | substate3 |    1   |    1   |  0  |  b  |
  Xor(a=clock0, b=clock1, out=sclInternal);
  Not(in=doneInternal, out=ndone);
  And(a=ndone, b=sclInternal, out=scl);
  // Since we want to send them in MSB -> LSB order,
  // we need to reverse them
  // 000 -> 111
  // 001 -> 110
  // 010 -> 101
  // 011 -> 100
  // 100 -> 011
  // 101 -> 010
  // 110 -> 001
  // 111 -> 000
  Not(in=clock2, out=bit0);
  Not(in=clock3, out=bit1);
  Not(in=clock4, out=bit2);
  Mux8Way(
    sel[0]=bit0,
    sel[1]=bit1,
    sel[2]=bit2,
    in=in,
    out=sda
  );

  And(a=clock0, b=clock1, out=clock01);
  And(a=clock2, b=clock3, out=clock23);
  And(a=clock01, b=clock23, out=clock0123);
  And(a=clock0123, b=clock4, out=clock01234);
  Blop(in=clock01234, out=rollover);

  Not(in=reset, out=nreset);
  Or(a=reset, b=rollover, out=setDone);
  FastBit(in=nreset, load=setDone, out=done, slowOut=doneInternal);
}
`).test(`
| time |   clock0   |    in    | sda | scl | done  |
| 1    |      0     | 00000000 |  0  |  0  |   0   |
| 2    |      1     | 00000000 |  0  |  1  |   0   |
| 3    |      0     | 00000000 |  0  |  1  |   0   |
| 4    |      1     | 00000000 |  0  |  0  |   0   |
| 5    |      0     | 00000000 |  0  |  0  |   0   |
| 6    |      1     | 00000000 |  0  |  1  |   0   |
| 7    |      0     | 00000000 |  0  |  1  |   0   |
| 8    |      1     | 00000000 |  0  |  0  |   0   |
| 9    |      0     | 00000000 |  0  |  0  |   0   |
| 10   |      1     | 00000000 |  0  |  1  |   0   |
| 11   |      0     | 00000000 |  0  |  1  |   0   |
| 12   |      1     | 00000000 |  0  |  0  |   0   |
| 13   |      0     | 00000000 |  0  |  0  |   0   |
| 14   |      1     | 00000000 |  0  |  1  |   0   |
| 15   |      0     | 00000000 |  0  |  1  |   0   |
| 16   |      1     | 00000000 |  0  |  0  |   0   |
| 17   |      0     | 00000000 |  0  |  0  |   0   |
| 18   |      1     | 00000000 |  0  |  1  |   0   |
| 19   |      0     | 00000000 |  0  |  1  |   0   |
| 20   |      1     | 00000000 |  0  |  0  |   0   |
| 21   |      0     | 00000000 |  0  |  0  |   0   |
| 22   |      1     | 00000000 |  0  |  1  |   0   |
| 23   |      0     | 00000000 |  0  |  1  |   0   |
| 24   |      1     | 00000000 |  0  |  0  |   0   |
| 25   |      0     | 00000000 |  0  |  0  |   0   |
| 26   |      1     | 00000000 |  0  |  1  |   0   |
| 27   |      0     | 00000000 |  0  |  1  |   0   |
| 28   |      1     | 00000000 |  0  |  0  |   0   |
| 29   |      0     | 00000000 |  0  |  0  |   0   |
| 30   |      1     | 00000000 |  0  |  1  |   0   |
| 31   |      0     | 00000000 |  0  |  1  |   0   |
| 32   |      1     | 00000000 |  0  |  0  |   0   |
| 33   |      0     | 00000000 |  0  |  0  |   1   |
| 34   |      1     | 00000000 |  0  |  0  |   1   |
| 35   |      0     | 00000000 |  0  |  0  |   1   |
| 36   |      0     | 10000001 |  1  |  0  |   0   |
| 37   |      1     | 10000001 |  1  |  1  |   0   |
| 38   |      0     | 10000001 |  1  |  1  |   0   |
| 39   |      1     | 10000001 |  1  |  0  |   0   |
| 40   |      0     | 10000001 |  0  |  0  |   0   |
| 41   |      1     | 10000001 |  0  |  1  |   0   |
| 42   |      0     | 10000001 |  0  |  1  |   0   |
| 43   |      1     | 10000001 |  0  |  0  |   0   |
| 44   |      0     | 10000001 |  0  |  0  |   0   |
| 45   |      1     | 10000001 |  0  |  1  |   0   |
| 46   |      0     | 10000001 |  0  |  1  |   0   |
| 47   |      1     | 10000001 |  0  |  0  |   0   |
| 48   |      0     | 10000001 |  0  |  0  |   0   |
| 49   |      1     | 10000001 |  0  |  1  |   0   |
| 50   |      0     | 10000001 |  0  |  1  |   0   |
| 51   |      1     | 10000001 |  0  |  0  |   0   |
| 52   |      0     | 10000001 |  0  |  0  |   0   |
| 53   |      1     | 10000001 |  0  |  1  |   0   |
| 54   |      0     | 10000001 |  0  |  1  |   0   |
| 55   |      1     | 10000001 |  0  |  0  |   0   |
| 56   |      0     | 10000001 |  0  |  0  |   0   |
| 57   |      1     | 10000001 |  0  |  1  |   0   |
| 58   |      0     | 10000001 |  0  |  1  |   0   |
| 59   |      1     | 10000001 |  0  |  0  |   0   |
| 60   |      0     | 10000001 |  0  |  0  |   0   |
| 61   |      1     | 10000001 |  0  |  1  |   0   |
| 62   |      0     | 10000001 |  0  |  1  |   0   |
| 63   |      1     | 10000001 |  0  |  0  |   0   |
| 64   |      0     | 10000001 |  1  |  0  |   0   |
| 65   |      1     | 10000001 |  1  |  1  |   0   |
| 66   |      0     | 10000001 |  1  |  1  |   0   |
| 67   |      1     | 10000001 |  1  |  0  |   0   |
| 68   |      0     | 01010101 |  0  |  0  |   0   |
| 69   |      1     | 01010101 |  0  |  1  |   0   |
| 70   |      0     | 01010101 |  0  |  1  |   0   |
| 71   |      1     | 01010101 |  0  |  0  |   0   |
| 72   |      0     | 01010101 |  1  |  0  |   0   |
| 73   |      1     | 01010101 |  1  |  1  |   0   |
| 74   |      0     | 01010101 |  1  |  1  |   0   |
| 75   |      1     | 01010101 |  1  |  0  |   0   |
| 76   |      0     | 01010101 |  0  |  0  |   0   |
| 77   |      1     | 01010101 |  0  |  1  |   0   |
| 78   |      0     | 01010101 |  0  |  1  |   0   |
| 79   |      1     | 01010101 |  0  |  0  |   0   |
| 80   |      0     | 01010101 |  1  |  0  |   0   |
| 81   |      1     | 01010101 |  1  |  1  |   0   |
| 82   |      0     | 01010101 |  1  |  1  |   0   |
| 83   |      1     | 01010101 |  1  |  0  |   0   |
| 84   |      0     | 01010101 |  0  |  0  |   0   |
| 85   |      1     | 01010101 |  0  |  1  |   0   |
| 86   |      0     | 01010101 |  0  |  1  |   0   |
| 87   |      1     | 01010101 |  0  |  0  |   0   |
| 88   |      0     | 01010101 |  1  |  0  |   0   |
| 89   |      1     | 01010101 |  1  |  1  |   0   |
| 90   |      0     | 01010101 |  1  |  1  |   0   |
| 91   |      1     | 01010101 |  1  |  0  |   0   |
| 92   |      0     | 01010101 |  0  |  0  |   0   |
| 93   |      1     | 01010101 |  0  |  1  |   0   |
| 94   |      0     | 01010101 |  0  |  1  |   0   |
| 95   |      1     | 01010101 |  0  |  0  |   0   |
| 96   |      0     | 01010101 |  1  |  0  |   0   |
| 97   |      1     | 01010101 |  1  |  1  |   0   |
| 98   |      0     | 01010101 |  1  |  1  |   0   |
| 99   |      1     | 01010101 |  1  |  0  |   0   |
`);
