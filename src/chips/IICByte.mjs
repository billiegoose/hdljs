import { ChipDef } from '../components/ChipDef.mjs';

export const IICByte = new ChipDef(`
CHIP IICByte {
  IN pulseClock, reset, begin, in[8];
  OUT sda, scl, ready;

  PARTS:
  // Fast clock (4 cycles / bit)
  Or(a=begin, b=continue, out=fastbegin);
  Clock4(
    pulseClock=pulseClock,
    reset=reset,
    begin=fastbegin,
    state0=substate0,
    state1=substate1,
    state2=substate2,
    state3=substate3,
    carry=fastCarry
  );
  And(a=state06, b=substate3, out=continue);

  // |           | scl | sda |
  // | substate0 |  0  |  b  |
  // | substate1 |  1  |  b  |
  // | substate2 |  1  |  b  |
  // | substate3 |  0  |  b  |
  Or(a=substate1, b=substate2, out=scl);

  Or(a=substate0, b=substate1, out=bitactive1);
  Or(a=substate2, b=substate3, out=bitactive2);
  Or(a=bitactive1, b=bitactive2, out=bitactive);
  And(a=bitactive, b=b, out=sda);

  // Slow clock (8 cycles / byte)
  Or(a=begin, b=substate3, out=slowPulse);
  Clock8(
    pulseClock=slowPulse,
    reset=reset,
    begin=begin,
    state0=state0,
    state1=state1,
    state2=state2,
    state3=state3,
    state4=state4,
    state5=state5,
    state6=state6,
    state7=state7
  );

  And(a=in[0], b=state0, out=bit0);
  And(a=in[1], b=state1, out=bit1);
  And(a=in[2], b=state2, out=bit2);
  And(a=in[3], b=state3, out=bit3);
  And(a=in[4], b=state4, out=bit4);
  And(a=in[5], b=state5, out=bit5);
  And(a=in[6], b=state6, out=bit6);
  And(a=in[7], b=state7, out=bit7);
  Or8Way(
    in[0]=bit0,
    in[1]=bit1,
    in[2]=bit2,
    in[3]=bit3,
    in[4]=bit4,
    in[5]=bit5,
    in[6]=bit6,
    in[7]=bit7,
    out=b
  );

  Or8Way(
    in[0]=state0,
    in[1]=state1,
    in[2]=state2,
    in[3]=state3,
    in[4]=state4,
    in[5]=state5,
    in[6]=state6,
    in[7]=false,
    out=state06
  );
  Or(a=state06, b=state7, out=active);
  Not(in=active, out=ready);
}`).test(`| time | reset | pulseClock | begin |    in    | sda | scl | ready |
| 1    |   0   |      1     |   0   | 00000000 |  0  |  0  |   1   |
| 2    |   0   |      1     |   0   | 00000000 |  0  |  0  |   1   |
| 3    |   0   |      1     |   1   | 00000000 |  0  |  0  |   0   |
| 4    |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 5    |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 6    |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 7    |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 8    |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 9    |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 10   |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 11   |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 12   |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 13   |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 14   |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 15   |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 16   |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 17   |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 18   |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 19   |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 20   |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 21   |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 22   |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 23   |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 24   |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 25   |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 26   |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 27   |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 28   |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 29   |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 30   |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 31   |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 32   |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 33   |   0   |      1     |   0   | 00000000 |  0  |  1  |   0   |
| 34   |   0   |      1     |   0   | 00000000 |  0  |  0  |   0   |
| 35   |   0   |      1     |   0   | 00000000 |  0  |  0  |   1   |
| 36   |   0   |      1     |   0   | 00000000 |  0  |  0  |   1   |
| 37   |   0   |      1     |   0   | 00000000 |  0  |  0  |   1   |
| 38   |   0   |      1     |   0   | 00000000 |  0  |  0  |   1   |
| 39   |   0   |      1     |   0   | 00000000 |  0  |  0  |   1   |
| 40   |   0   |      1     |   0   | 00000000 |  0  |  0  |   1   |
| 41   |   0   |      1     |   0   | 00000000 |  0  |  0  |   1   |
| 42   |   0   |      1     |   0   | 10000001 |  0  |  0  |   1   |
| 43   |   0   |      1     |   1   | 10000001 |  1  |  0  |   0   |
| 44   |   0   |      1     |   0   | 10000001 |  1  |  1  |   0   |
| 45   |   0   |      1     |   0   | 10000001 |  1  |  1  |   0   |
| 46   |   0   |      1     |   0   | 10000001 |  1  |  0  |   0   |
| 47   |   0   |      1     |   0   | 10000001 |  0  |  0  |   0   |
| 48   |   0   |      1     |   0   | 10000001 |  0  |  1  |   0   |
| 49   |   0   |      1     |   0   | 10000001 |  0  |  1  |   0   |
| 50   |   0   |      1     |   0   | 10000001 |  0  |  0  |   0   |
| 51   |   0   |      1     |   0   | 10000001 |  0  |  0  |   0   |
| 52   |   0   |      1     |   0   | 10000001 |  0  |  1  |   0   |
| 53   |   0   |      1     |   0   | 10000001 |  0  |  1  |   0   |
| 54   |   0   |      1     |   0   | 10000001 |  0  |  0  |   0   |
| 55   |   0   |      1     |   0   | 10000001 |  0  |  0  |   0   |
| 56   |   0   |      1     |   0   | 10000001 |  0  |  1  |   0   |
| 57   |   0   |      1     |   0   | 10000001 |  0  |  1  |   0   |
| 58   |   0   |      1     |   0   | 10000001 |  0  |  0  |   0   |
| 59   |   0   |      1     |   0   | 10000001 |  0  |  0  |   0   |
| 60   |   0   |      1     |   0   | 10000001 |  0  |  1  |   0   |
| 61   |   0   |      1     |   0   | 10000001 |  0  |  1  |   0   |
| 62   |   0   |      1     |   0   | 10000001 |  0  |  0  |   0   |
| 63   |   0   |      1     |   0   | 10000001 |  0  |  0  |   0   |
| 64   |   0   |      1     |   0   | 10000001 |  0  |  1  |   0   |
| 65   |   0   |      1     |   0   | 10000001 |  0  |  1  |   0   |
| 66   |   0   |      1     |   0   | 10000001 |  0  |  0  |   0   |
| 67   |   0   |      1     |   0   | 10000001 |  0  |  0  |   0   |
| 68   |   0   |      1     |   0   | 10000001 |  0  |  1  |   0   |
| 69   |   0   |      1     |   0   | 10000001 |  0  |  1  |   0   |
| 70   |   0   |      1     |   0   | 10000001 |  0  |  0  |   0   |
| 71   |   0   |      1     |   0   | 10000001 |  1  |  0  |   0   |
| 72   |   0   |      1     |   0   | 10000001 |  1  |  1  |   0   |
| 73   |   0   |      1     |   0   | 10000001 |  1  |  1  |   0   |
| 74   |   0   |      1     |   0   | 10000001 |  1  |  0  |   0   |
| 75   |   0   |      1     |   0   | 10000001 |  0  |  0  |   1   |
| 76   |   0   |      1     |   0   | 10000001 |  0  |  0  |   1   |
| 77   |   0   |      1     |   0   | 10000001 |  0  |  0  |   1   |
| 78   |   0   |      1     |   0   | 10000001 |  0  |  0  |   1   |
| 79   |   0   |      1     |   0   | 10000001 |  0  |  0  |   1   |
| 80   |   0   |      1     |   0   | 10000001 |  0  |  0  |   1   |
| 81   |   0   |      1     |   0   | 10000001 |  0  |  0  |   1   |
| 82   |   0   |      1     |   0   | 10000001 |  0  |  0  |   1   |
| 83   |   0   |      1     |   0   | 10000001 |  0  |  0  |   1   |
| 84   |   0   |      1     |   0   | 01010101 |  0  |  0  |   1   |
| 85   |   0   |      1     |   0   | 01010101 |  0  |  0  |   1   |
| 86   |   0   |      1     |   1   | 01010101 |  1  |  0  |   0   |
| 87   |   0   |      1     |   0   | 01010101 |  1  |  1  |   0   |
| 88   |   0   |      1     |   0   | 01010101 |  1  |  1  |   0   |
| 89   |   0   |      1     |   0   | 01010101 |  1  |  0  |   0   |
| 90   |   0   |      1     |   0   | 01010101 |  0  |  0  |   0   |
| 91   |   0   |      1     |   0   | 01010101 |  0  |  1  |   0   |
| 92   |   0   |      1     |   0   | 01010101 |  0  |  1  |   0   |
| 93   |   0   |      1     |   0   | 01010101 |  0  |  0  |   0   |
| 94   |   0   |      1     |   0   | 01010101 |  1  |  0  |   0   |
| 95   |   0   |      1     |   0   | 01010101 |  1  |  1  |   0   |
| 96   |   0   |      1     |   0   | 01010101 |  1  |  1  |   0   |
| 97   |   0   |      1     |   0   | 01010101 |  1  |  0  |   0   |
| 98   |   0   |      1     |   0   | 01010101 |  0  |  0  |   0   |
| 99   |   0   |      1     |   0   | 01010101 |  0  |  1  |   0   |
| 100  |   0   |      1     |   0   | 01010101 |  0  |  1  |   0   |
| 101  |   0   |      1     |   0   | 01010101 |  0  |  0  |   0   |
| 102  |   0   |      1     |   0   | 01010101 |  1  |  0  |   0   |
| 103  |   0   |      1     |   0   | 01010101 |  1  |  1  |   0   |
| 104  |   0   |      1     |   0   | 01010101 |  1  |  1  |   0   |
| 105  |   0   |      1     |   0   | 01010101 |  1  |  0  |   0   |
| 106  |   0   |      1     |   0   | 01010101 |  0  |  0  |   0   |
| 107  |   0   |      1     |   0   | 01010101 |  0  |  1  |   0   |
| 108  |   0   |      1     |   0   | 01010101 |  0  |  1  |   0   |
| 109  |   0   |      1     |   0   | 01010101 |  0  |  0  |   0   |
| 110  |   0   |      1     |   0   | 01010101 |  1  |  0  |   0   |
| 111  |   0   |      1     |   0   | 01010101 |  1  |  1  |   0   |
| 112  |   0   |      1     |   0   | 01010101 |  1  |  1  |   0   |
| 113  |   0   |      1     |   0   | 01010101 |  1  |  0  |   0   |
| 114  |   0   |      1     |   0   | 01010101 |  0  |  0  |   0   |
| 115  |   0   |      1     |   0   | 01010101 |  0  |  1  |   0   |
| 116  |   0   |      1     |   0   | 01010101 |  0  |  1  |   0   |
| 117  |   0   |      1     |   0   | 01010101 |  0  |  0  |   0   |
| 118  |   0   |      1     |   0   | 01010101 |  0  |  0  |   1   |
| 119  |   0   |      1     |   0   | 01010101 |  0  |  0  |   1   |
| 120  |   0   |      1     |   0   | 01010101 |  0  |  0  |   1   |
| 121  |   0   |      1     |   0   | 01010101 |  0  |  0  |   1   |
| 122  |   0   |      1     |   0   | 01010101 |  0  |  0  |   1   |
| 123  |   0   |      1     |   0   | 01010101 |  0  |  0  |   1   |
| 124  |   0   |      1     |   0   | 01010101 |  0  |  0  |   1   |
`);
